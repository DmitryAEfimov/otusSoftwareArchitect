apiVersion: batch/v1
kind: Job

metadata:
  name: flyway-migration
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: flyway
          image: defimov/flyway:v1
          env:
            - name: DB_HOSTNAME
              valueFrom:
                configMapKeyRef:
                  name: db-config
                  key: hostname
            - name: DB_NAME
              valueFrom:
                configMapKeyRef:
                  name: db-config
                  key: dbname
            - name: DB_USER
              valueFrom:
                configMapKeyRef:
                  name: db-config
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: password
      initContainers:
        - name: check-db-ready
          image: alpine:3.11
          env:
            - name: DB_HOSTNAME
              valueFrom:
                configMapKeyRef:
                  name: db-config
                  key: hostname
          command:
            - sh
            - "-c"
            - |
              apk add postgresql-client && until pg_isready -h $DB_HOSTNAME; do echo waiting for database; sleep 2; done;
  backoffLimit: 0